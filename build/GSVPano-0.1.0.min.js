var GSVPANO=GSVPANO||{};
GSVPANO.PanoLoader=function(l){l=l||{};var e,m,r=new google.maps.StreetViewService,h=0,n=0,k=document.createElement("canvas"),s=k.getContext("2d"),p=0,q=0;this.setProgress=function(a){if(this.onProgress)this.onProgress(a)};this.throwError=function(a){if(this.onError)this.onError(a);else console.error(a)};this.adaptTextureToZoom=function(){var a=416*Math.pow(2,e),c=416*Math.pow(2,e-1);k.width=a;k.height=c};this.composeFromTile=function(a,c,b){s.drawImage(b,512*a,512*c);h++;a=Math.round(100*h/n);this.setProgress(a);
if(h===n&&(this.canvas=k,this.onPanoramaLoad))this.onPanoramaLoad()};this.composePanorama=function(a){this.setProgress(0);a=3==e?7:Math.pow(2,e);var c=Math.pow(2,e-1),b=this,d,f,g;h=0;n=a*c;for(g=0;g<c;g++)for(f=0;f<a;f++)d="http://maps.google.com/cbk?output=tile&panoid="+m+"&zoom="+e+"&x="+f+"&y="+g+"&"+Date.now(),function(a,f){var c=new Image;c.addEventListener("load",function(){b.composeFromTile(a,f,this)});c.crossOrigin="";c.src=d}(f,g)};this.loadData=function(a){var c=this,b;b="https://maps.google.com/cbk?output=json&hl=x-local&ll="+
a.lat()+","+a.lng()+"&cb_client=maps_sv&v=3";b="https://cbks0.google.com/cbk?cb_client=maps_sv.tactile&authuser=0&hl=en&output=polygon&it=1%3A1&rank=closest&ll="+a.lat()+","+a.lng()+"&radius=350";var d=new XMLHttpRequest;d.open("GET",b,!0);d.onreadystatechange=function(){if(4==d.readyState&&200==d.status){var b=JSON.parse(d.responseText);c.loadPano(a,b.result[0].id)}};d.send(null)};this.load=function(a,c){var b=this;r.getPanoramaByLocation(a,50,function(d,c){if(c===google.maps.StreetViewStatus.OK){if(b.onPanoramaData)b.onPanoramaData(d);
p=d.tiles.centerHeading*Math.PI/180;q=d.tiles.originPitch;b.copyright=d.copyright;m=d.location.pano;b.location=a;b.rotation=p;b.pitch=q;b.image_date=d.imageDate;b.id=m;b.composePanorama()}else{if(b.onNoPanoramaData)b.onNoPanoramaData(c);b.throwError("Could not retrieve panorama for the following reason: "+c)}})};this.setZoom=function(a){e=a;this.adaptTextureToZoom()};this.setZoom(l.zoom||1)};
